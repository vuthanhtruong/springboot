<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trang Cá Nhân</title>
    <link href="/css/style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<header>
    <h1>Thông Tin Cá Nhân</h1>
</header>

<main>
    <!-- Hiển thị thông báo thành công -->
    <div class="alert alert-success" th:if="${success}">
        <span th:switch="${success}">
            <span th:case="'Đăng ký giọng nói thành công!'">Đăng ký giọng nói thành công!</span>
            <span th:case="'Xóa giọng nói thành công!'">Xóa giọng nói thành công!</span>
            <span th:case="*">Đăng ký khuôn mặt thành công!</span>
        </span>
    </div>
    <div class="alert alert-success" th:if="${successDelete}">
        Xóa khuôn mặt thành công!
    </div>

    <!-- Hiển thị lỗi từ Model (FaceLoginController) -->
    <div class="alert alert-danger" th:if="${error}">
        <span th:switch="${error}">
            <span th:case="'not_logged_in'">Vui lòng đăng nhập để tiếp tục.</span>
            <span th:case="'user_not_found'">Không tìm thấy người dùng.</span>
            <span th:case="'save_failed'">Lưu thông tin thất bại. Vui lòng thử lại.</span>
            <span th:case="'invalid_face'">Ảnh khuôn mặt không hợp lệ.</span>
            <span th:case="'face_not_matched'">Khuôn mặt không khớp với tài khoản.</span>
            <span th:case="'no_face_to_delete'">Chưa có khuôn mặt để xóa.</span>
            <span th:case="'delete_failed'">Xóa thất bại. Vui lòng thử lại.</span>
            <span th:case="'invalid_voice'">Giọng nói không hợp lệ.</span>
            <span th:case="'no_voice_to_delete'">Chưa có giọng nói để xóa.</span>
            <span th:case="*">Đã có lỗi xảy ra: <span th:text="${error}"></span></span>
        </span>
    </div>

    <!-- Hiển thị lỗi từ RedirectAttributes qua param.error (VoiceAuthController) -->
    <div class="alert alert-danger" th:if="${param.error}">
        <span th:switch="${param.error}">
            <span th:case="'not_logged_in'">Vui lòng đăng nhập để tiếp tục.</span>
            <span th:case="'user_not_found'">Không tìm thấy người dùng.</span>
            <span th:case="'save_failed'">Lưu thông tin thất bại. Vui lòng thử lại.</span>
            <span th:case="'invalid_voice'">Giọng nói không hợp lệ.</span>
            <span th:case="'no_voice_to_delete'">Chưa có giọng nói để xóa.</span>
            <span th:case="'delete_failed'">Xóa thất bại. Vui lòng thử lại.</span>
            <span th:case="*">Đã có lỗi xảy ra: <span th:text="${param.error}"></span></span>
        </span>
    </div>

    <!-- Hiển thị cảnh báo từ noteFace -->
    <div class="alert alert-warning" th:if="${noteFace}">
        <span th:switch="${noteFace}">
            <span th:case="'face_already_registered'">Đã có người đăng ký khuôn mặt này rồi.</span>
            <span th:case="*"><span th:text="${noteFace}"></span></span>
        </span>
    </div>

    <!-- Mục Hồ Sơ Cá Nhân -->
    <section class="profile-section">
        <h2><i class="fas fa-user"></i> Hồ Sơ Cá Nhân</h2>
        <form th:action="@{/LuuThongTinCaNhan}" th:method="post">
            <div class="form-group">
                <label><strong>ID:</strong></label>
                <span th:text="${user.id}"></span>
            </div>
            <div class="form-group">
                <label><strong>Họ và Tên:</strong></label>
                <input autocomplete="off" class="form-control d-inline-block w-auto" name="firstName"
                       placeholder="Nhập Họ" required
                       th:value="${user.firstName}" type="text">
                <input autocomplete="off" class="form-control d-inline-block w-auto" name="lastName"
                       placeholder="Nhập Tên" required
                       th:value="${user.lastName}" type="text">
            </div>
            <div class="form-group">
                <label><strong>Email:</strong></label>
                <input autocomplete="off" class="form-control" name="email" placeholder="Nhập Email" required
                       th:value="${user.email}" type="email">
            </div>
            <div class="form-group">
                <label><strong>Số Điện Thoại:</strong></label>
                <input autocomplete="off" class="form-control" name="phoneNumber" placeholder="Nhập Số Điện Thoại"
                       required th:value="${user.phoneNumber}" type="text">
            </div>
            <button class="btn btn-primary" type="submit"><i class="fas fa-save"></i> Lưu</button>
        </form>
    </section>

    <!-- Mục Đăng Ký Khuôn Mặt -->
    <section class="face-registration-section">
        <h2><i class="fas fa-camera"></i> Đăng Ký Khuôn Mặt</h2>
        <p th:if="${user.faceData != null && !user.faceData.isEmpty()}">Bạn đã đăng ký khuôn mặt.</p>
        <p th:unless="${user.faceData != null && !user.faceData.isEmpty()}">Bạn chưa đăng ký khuôn mặt.</p>
        <form th:action="@{/DangKyKhuonMat}" th:method="post">
            <video autoplay height="240" id="video" style="transform: scaleX(-1);" width="320"></video>
            <div class="mt-2">
                <button class="btn btn-info" onclick="toggleCamera()" type="button">Bật/Tắt Camera</button>
                <button class="btn btn-success" onclick="captureFace('faceData')" type="button">Chụp Khuôn Mặt</button>
            </div>
            <input id="faceData" name="faceData" type="hidden">
            <span class="text-success mt-2" id="captureStatus" style="display: none;">Đã chụp khuôn mặt!</span>
            <button class="btn btn-primary mt-2" type="submit"><i class="fas fa-upload"></i> Đăng Ký</button>
        </form>
    </section>

    <!-- Nút Xóa Khuôn Mặt -->
    <section class="face-delete-section">
        <h2><i class="fas fa-trash"></i> Xóa Khuôn Mặt</h2>
        <a class="btn btn-danger" th:href="@{/XoaKhuonMat}"><i class="fas fa-trash-alt"></i> Xóa Khuôn Mặt Hiện Có</a>
    </section>

    <!-- Mục Đăng Ký Giọng Nói -->
    <section class="voice-registration-section">
        <h2><i class="fas fa-microphone"></i> Đăng Ký Giọng Nói</h2>
        <p th:if="${user.voiceData != null && !user.voiceData.isEmpty()}">Bạn đã đăng ký giọng nói: <span
                th:text="${user.voiceData}"></span></p>
        <p th:unless="${user.voiceData != null && !user.voiceData.isEmpty()}">Bạn chưa đăng ký giọng nói.</p>
        <form th:action="@{/DangKyGiongNoi}" th:method="post">
            <button class="btn btn-info" onclick="startVoiceRecording('voiceData')" type="button">Bắt Đầu Ghi Âm
            </button>
            <input id="voiceData" name="voiceData" type="hidden">
            <span class="text-success mt-2" id="recordStatus" style="display: none;">Đã ghi âm!</span>
            <button class="btn btn-primary mt-2" type="submit"><i class="fas fa-upload"></i> Đăng Ký</button>
        </form>
    </section>

    <!-- Nút Xóa Giọng Nói -->
    <section class="voice-delete-section">
        <h2><i class="fas fa-trash"></i> Xóa Giọng Nói</h2>
        <a class="btn btn-danger" th:href="@{/XoaGiongNoi}"><i class="fas fa-trash-alt"></i> Xóa Giọng Nói Hiện Có</a>
    </section>

    <!-- Mục Bảo Mật -->
    <section class="password-section">
        <h2><i class="fas fa-key"></i> Bảo Mật</h2>
        <a class="btn btn-warning" href="/DoiMatKhau"><i class="fas fa-lock"></i> Đổi Mật Khẩu</a>
    </section>

    <!-- Điều Hướng -->
    <section class="navigation-section">
        <a class="btn btn-primary" th:href="@{/redirect}"><i class="fas fa-home"></i> Quay về Trang Chủ</a>
        <a class="btn btn-danger" href="/DangXuat"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
    </section>
</main>

<script>
    let video = document.getElementById('video');
    let captureStatus = document.getElementById('captureStatus');
    let stream = null;

    window.onload = function () {
        startCamera();
    };

    function startCamera() {
        navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}})
            .then(function (videoStream) {
                stream = videoStream;
                video.srcObject = stream;
            })
            .catch(function (err) {
                console.log("Lỗi webcam đăng ký: " + err);
                alert("Không thể truy cập webcam cho đăng ký: " + err.message);
            });
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            stream = null;
        }
    }

    function toggleCamera() {
        if (video.srcObject) {
            stopCamera();
        } else {
            startCamera();
        }
    }

    function captureFace(inputId) {
        let targetVideo = document.getElementById('video');
        let targetStatus = captureStatus;

        if (!targetVideo.srcObject) {
            alert("Vui lòng bật camera trước khi chụp!");
            return;
        }
        let canvas = document.createElement('canvas');
        canvas.width = targetVideo.videoWidth;
        canvas.height = targetVideo.videoHeight;
        let context = canvas.getContext('2d');
        context.drawImage(targetVideo, 0, 0, canvas.width, canvas.height);
        let faceData = canvas.toDataURL('image/png');
        document.getElementById(inputId).value = faceData;
        targetStatus.style.display = 'block';
        setTimeout(() => targetStatus.style.display = 'none', 3000);
    }
</script>

<script>
    function startVoiceRecording(inputId) {
        let audioInput = document.getElementById(inputId);
        let recordStatus = document.getElementById('recordStatus');

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'vi-VN';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onresult = function (event) {
            const transcript = event.results[0][0].transcript;
            audioInput.value = transcript;
            recordStatus.style.display = 'block';
            setTimeout(() => recordStatus.style.display = 'none', 3000);
        };

        recognition.onerror = function (event) {
            console.error('Lỗi ghi âm: ', event.error);
            alert("Không thể ghi âm: " + event.error);
        };

        recognition.onend = function () {
            console.log('Ghi âm kết thúc');
        };

        recognition.start();
        setTimeout(() => recognition.stop(), 10000);
    }
</script>

<style>
    .alert {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 5px;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
    }

    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
    }

    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .text-success {
        color: #28a745;
    }

    section {
        margin-bottom: 20px;
    }
</style>

</body>
</html>